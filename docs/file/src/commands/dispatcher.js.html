<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/commands/dispatcher.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/Gawdl3y/discord-graf.git" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/util.js~Util.html">Util</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-loadYargs">loadYargs</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setDefaults">setDefaults</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setValues">setValues</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isAdmin">isAdmin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isMod">isMod</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-defaults">defaults</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-values">values</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-graf">graf</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-serverCommandPatterns">serverCommandPatterns</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-unprefixedCommandPattern">unprefixedCommandPattern</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-version">version</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">commands</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-handleMessage">handleMessage</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-makeResultObject">makeResultObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-matchDefault">matchDefault</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-parseMessage">parseMessage</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-run">run</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sendMessages">sendMessages</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sendMessagesForResult">sendMessagesForResult</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-updateMessages">updateMessages</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-updateMessagesForResult">updateMessagesForResult</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-find">find</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isUsable">isUsable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-nameGroup">nameGroup</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-register">register</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-commandResults">commandResults</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-serverCommandPatterns">serverCommandPatterns</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-unprefixedCommandPattern">unprefixedCommandPattern</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-commands">commands</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-groups">groups</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">database</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/database/mod-role.js~ModRole.html">ModRole</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/database/setting.js~Setting.html">Setting</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/database/usable-channel.js~UsableChannel.html">UsableChannel</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">errors</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/errors/command-format.js~CommandFormatError.html">CommandFormatError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/errors/friendly.js~FriendlyError.html">FriendlyError</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/commands/dispatcher.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">&apos;use babel&apos;;
&apos;use strict&apos;;

import stringArgv from &apos;string-argv&apos;;
import { stripIndents } from &apos;common-tags&apos;;
import bot from &apos;..&apos;;
import * as registry from &apos;./registry&apos;;
import config from &apos;../config&apos;;
import UsableChannel from &apos;../database/usable-channel&apos;;
import * as permissions from &apos;../permissions&apos;;
import FriendlyError from &apos;../errors/friendly&apos;;
import Util from &apos;../util&apos;;

export const serverCommandPatterns = {};
export const unprefixedCommandPattern = /^([^\s]+)/i;
export const commandResults = {};

// Handle a raw message
export async function handleMessage(message, oldMessage = null) {
	// Make sure the bot is allowed to run in the channel, or the user is an admin
	if(message.server &amp;&amp; UsableChannel.serverHasAny(message.server)
		&amp;&amp; !UsableChannel.serverHas(message.server, message.channel)
		&amp;&amp; !permissions.isAdmin(message.server, message.author)) return;

	// Parse the message, and get the old result if it exists
	const [command, args, fromPattern, isCommandMessage] = parseMessage(message);
	const oldResult = oldMessage ? commandResults[oldMessage.id] : null;

	// Run the command, or make an error message result
	let result;
	if(command) {
		if(!oldMessage || oldResult) result = makeResultObject(await run(command, args, fromPattern, message));
	} else if(isCommandMessage) {
		result = { reply: [`Unknown command. Use ${Util.usage(&apos;help&apos;, message.server)} to view the list of all commands.`], editable: true };
	} else if(config.nonCommandEdit) {
		result = {};
	}

	if(result) {
		// Change a plain or reply response into direct if there isn&apos;t a server
		if(!message.server) {
			if(!result.direct) result.direct = result.plain || result.reply;
			delete result.plain;
			delete result.reply;
		}

		// Update old messages or send new ones
		if(oldResult &amp;&amp; (oldResult.plain || oldResult.reply || oldResult.direct)) {
			await updateMessagesForResult(message, result, oldResult);
		} else {
			await sendMessagesForResult(message, result);
		}

		// Cache the result
		if(config.commandEditable &gt; 0) {
			if(result.editable) {
				result.timeout = oldResult &amp;&amp; oldResult.timeout ? oldResult.timeout : setTimeout(() =&gt; { delete commandResults[message.id]; }, config.commandEditable * 1000);
				commandResults[message.id] = result;
			} else {
				delete commandResults[message.id];
			}
		}
	}
}

// Run a command
export async function run(command, args, fromPattern, message) {
	const logInfo = {
		args: String(args),
		user: `${message.author.username}#${message.author.discriminator}`,
		userID: message.author.id,
		server: message.server ? message.server.name : null,
		serverID: message.server ? message.server.id : null
	};

	// Make sure the command is usable
	if(command.serverOnly &amp;&amp; !message.server) {
		bot.logger.info(`Not running ${command.group}:${command.groupName}; server only.`, logInfo);
		return `The \`${command.name}\` command must be used in a server channel.`;
	}
	if(command.isRunnable &amp;&amp; !command.isRunnable(message)) {
		bot.logger.info(`Not running ${command.group}:${command.groupName}; not runnable.`, logInfo);
		return `You do not have permission to use the \`${command.name}\` command.`;
	}

	// Run the command
	bot.logger.info(`Running ${command.group}:${command.groupName}.`, logInfo);
	try {
		return await command.run(message, args, fromPattern);
	} catch(err) {
		if(err instanceof FriendlyError) {
			return err.message;
		} else {
			bot.logger.error(err);
			const owner = config.owner ? message.client.users.get(&apos;id&apos;, config.owner) : null;
			return stripIndents`
				An error occurred while running the command: \`${err.name}: ${err.message}\`
				${owner ? `Please contact ${owner.name}#${owner.discriminator}${config.invite ? ` in this server: ${config.invite}` : &apos;.&apos;}` : &apos;&apos;}
			`;
		}
	}
}

// Get a result object from running a command
export function makeResultObject(result) {
	if(typeof result !== &apos;object&apos; || Array.isArray(result)) result = { reply: result };
	if(!(&apos;editable&apos; in result)) result.editable = true;
	if(result.plain &amp;&amp; result.reply) throw new Error(&apos;The command result may contain either &quot;plain&quot; or &quot;reply&quot;, not both.&apos;);
	if(result.plain &amp;&amp; !Array.isArray(result.plain)) result.plain = [result.plain];
	if(result.reply &amp;&amp; !Array.isArray(result.reply)) result.reply = [result.reply];
	if(result.direct &amp;&amp; !Array.isArray(result.direct)) result.direct = [result.direct];
	return result;
}

// Send messages for a result object
export async function sendMessagesForResult(message, result) {
	const messages = await Promise.all([
		result.plain ? sendMessages(message, result.plain, &apos;plain&apos;) : null,
		result.reply ? sendMessages(message, result.reply, &apos;reply&apos;) : null,
		result.direct ? sendMessages(message, result.direct, &apos;direct&apos;) : null
	]);
	if(result.plain) result.normalMessages = messages[0];
	else if(result.reply) result.normalMessages = messages[1];
	if(result.direct) result.directMessages = messages[2];
}

// Send messages in response to a message
export async function sendMessages(message, contents, type) {
	const sentMessages = [];
	for(const content of contents) {
		if(type === &apos;plain&apos;) sentMessages.push(await message.client.sendMessage(message, content));
		else if(type === &apos;reply&apos;) sentMessages.push(await message.reply(content));
		else if(type === &apos;direct&apos;) sentMessages.push(await message.client.sendMessage(message.author, content));
	}
	return sentMessages;
}

// Update old messages to reflect a new result
export async function updateMessagesForResult(message, result, oldResult) {
	// Update the messages
	const messages = await Promise.all([
		result.plain || result.reply ? updateMessages(message, oldResult.normalMessages, result.plain ? result.plain : result.reply, result.plain ? &apos;plain&apos; : &apos;reply&apos;) : null,
		result.direct ? oldResult.direct ? updateMessages(message, oldResult.directMessages, result.direct, &apos;direct&apos;) : sendMessages(message, result.direct, &apos;direct&apos;) : null
	]);
	if(result.plain || result.reply) result.normalMessages = messages[0];
	if(result.direct) result.directMessages = messages[1];

	// Delete old messages if we&apos;re not using them
	if(!result.plain &amp;&amp; !result.reply &amp;&amp; (oldResult.plain || oldResult.reply)) for(const msg of oldResult.normalMessages) msg.delete();
	if(!result.direct &amp;&amp; oldResult.direct) for(const msg of oldResult.directMessages) msg.delete();
}

// Update messages in response to a message
export async function updateMessages(message, oldMessages, contents, type) {
	const updatedMessages = [];

	// Update/send messages
	for(let i = 0; i &lt; contents.length; i++) {
		if(i &lt; oldMessages.length) updatedMessages.push(await oldMessages[i].update(type === &apos;reply&apos; ? `${message.author}, ${contents[i]}` : contents[i]));
		else updatedMessages.push((await sendMessages(message, [contents[i]], type))[0]);
	}

	// Delete extra old messages
	if(oldMessages.length &gt; contents.length) {
		for(let i = oldMessages.length - 1; i &gt;= contents.length; i--) oldMessages[i].delete();
	}

	return updatedMessages;
}

// Get an array of metadata for a command in a message
export function parseMessage(message) {
	// Find the command to run by patterns
	for(const command of registry.commands) {
		if(!command.patterns) continue;
		for(const pattern of command.patterns) {
			const matches = pattern.exec(message.content);
			if(matches) return [command, matches, true, true];
		}
	}

	// Find the command to run with default command handling
	const patternIndex = message.server ? message.server.id : &apos;-&apos;;
	if(!serverCommandPatterns[patternIndex]) serverCommandPatterns[patternIndex] = Util._buildCommandPattern(message.server, message.client.user);
	let [command, args, isCommandMessage] = matchDefault(message, serverCommandPatterns[patternIndex], 2);
	if(!command &amp;&amp; !message.server) [command, args, isCommandMessage] = matchDefault(message, unprefixedCommandPattern);
	if(command) return [command, args, false, true];

	return [null, null, false, isCommandMessage];
}

// Find the command and arguments from a default matches pattern
const newlinesPattern = /\n/g;
const newlinesReplacement = &apos;{!~NL~!}&apos;;
const newlinesReplacementPattern = new RegExp(newlinesReplacement, &apos;g&apos;);
const extraNewlinesPattern = /\n{3,}/g;
export function matchDefault(message, pattern, commandNameIndex = 1) {
	const matches = pattern.exec(message.content);
	if(!matches) return [null, null, false];

	const commandName = matches[commandNameIndex].toLowerCase();
	const command = registry.commands.find(cmd =&gt; cmd.name === commandName || (cmd.aliases &amp;&amp; cmd.aliases.some(alias =&gt; alias === commandName)));
	if(!command || command.disableDefault) return [null, null, true];

	const argString = message.content.substring(matches[1].length + (matches[2] ? matches[2].length : 0));
	let args;
	if(!(&apos;argsType&apos; in command) || command.argsType === &apos;single&apos;) {
		args = [argString.trim()];
	} else if(command.argsType === &apos;multiple&apos;) {
		if(&apos;argsCount&apos; in command) {
			if(command.argsCount &lt; 2) throw new RangeError(`Command ${command.group}:${command.groupName} argsCount must be at least 2.`);
			args = [];
			const newlinesReplaced = argString.trim().replace(newlinesPattern, newlinesReplacement);
			const argv = stringArgv(newlinesReplaced);
			if(argv.length &gt; 0) {
				for(let i = 0; i &lt; command.argsCount - 1; i++) args.push(argv.shift());
				if(argv.length &gt; 0) args.push(argv.join(&apos; &apos;).replace(newlinesReplacementPattern, &apos;\n&apos;).replace(extraNewlinesPattern, &apos;\n\n&apos;));
			}
		} else {
			args = stringArgv(argString);
		}
	} else {
		throw new Error(`Command ${command.group}:${command.groupName} argsType is not one of &apos;single&apos; or &apos;multiple&apos;.`);
	}

	return [command, args, true];
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.8)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
