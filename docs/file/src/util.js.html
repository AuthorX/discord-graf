<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/util.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/Gawdl3y/discord-graf.git" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/util.js~Util.html">Util</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-loadYargs">loadYargs</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setDefaults">setDefaults</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setValues">setValues</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isAdmin">isAdmin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isMod">isMod</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-defaults">defaults</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-values">values</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-graf">graf</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-serverCommandPatterns">serverCommandPatterns</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-unprefixedCommandPattern">unprefixedCommandPattern</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-version">version</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">commands</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-handleMessage">handleMessage</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-makeResultObject">makeResultObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-matchDefault">matchDefault</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-parseMessage">parseMessage</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-run">run</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sendMessages">sendMessages</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sendMessagesForResult">sendMessagesForResult</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-updateMessages">updateMessages</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-updateMessagesForResult">updateMessagesForResult</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-find">find</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isUsable">isUsable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-nameGroup">nameGroup</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-register">register</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-commandResults">commandResults</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-serverCommandPatterns">serverCommandPatterns</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-unprefixedCommandPattern">unprefixedCommandPattern</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-commands">commands</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-groups">groups</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">database</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/database/mod-role.js~ModRole.html">ModRole</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/database/setting.js~Setting.html">Setting</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/database/usable-channel.js~UsableChannel.html">UsableChannel</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">errors</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/errors/command-format.js~CommandFormatError.html">CommandFormatError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/errors/friendly.js~FriendlyError.html">FriendlyError</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/util.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">&apos;use babel&apos;;
&apos;use strict&apos;;

import escapeRegex from &apos;escape-string-regexp&apos;;
import request from &apos;request&apos;;
import semver from &apos;semver&apos;;
import bot from &apos;.&apos;;
import config from &apos;./config&apos;;
import Setting from &apos;./database/setting&apos;;

const nbsp = &apos;\xa0&apos;;
const spacePattern = / /g;
const patterns = {
	userID: /^(?:&lt;@!?)?([0-9]+)&gt;?$/,
	roleID: /^(?:&lt;@&amp;)?([0-9]+)&gt;?$/,
	channelID: /^(?:&lt;#)?([0-9]+)&gt;?$/
};

export default class Util {
	/**
	 * Build a command usage string
	 * @param {string} command - The short command string (ex. &quot;roll d20&quot;)
	 * @param {?Server} [server=null] - The Discord.js Server instance of the server to use the prefix of
	 * @param {boolean} [onlyMention=false] - Whether or not the usage string should only show the mention form
	 * @return {string} The command usage string
	 */
	static usage(command, server = null, onlyMention = false) {
		const nbcmd = this.nbsp(command);
		if(!server &amp;&amp; !onlyMention) return `\`${nbcmd}\``;
		let prefixAddon;
		if(!onlyMention) {
			let prefix = this.nbsp(Setting.getValue(&apos;command-prefix&apos;, config.commandPrefix, server));
			if(prefix.length &gt; 1) prefix += &apos;\xa0&apos;;
			prefixAddon = prefix ? `\`${prefix}${nbcmd}\` or ` : &apos;&apos;;
		}
		return `${prefixAddon ? prefixAddon : &apos;&apos;}\`@${this.nbsp(bot.client.user.name)}#${bot.client.user.discriminator}\xa0${nbcmd}\``;
	}

	/**
	 * Build a disambiguation list - useful for telling a user to be more specific when finding partial matches from a command
	 * @param {Object[]} items - An array of items to make the disambiguation list for
	 * @param {string} label - The text to refer to the items as (ex. &quot;characters&quot;)
	 * @param {string} [property=name] - The property on items to display in the list
	 * @return {string} The disambiguation list
	 */
	static disambiguation(items, label, property = &apos;name&apos;) {
		const itemList = items.map(item =&gt; `&quot;${this.nbsp(property ? item[property] : item)}&quot;`).join(&apos;,   &apos;);
		return `Multiple ${label} found, please be more specific: ${itemList}`;
	}

	/**
	 * Paginate an array of items
	 * @param {Object[]} items - An array of items to paginate
	 * @param {number} [page=1] - The page to select
	 * @param {number} [pageLength=10] - The number of items per page
	 * @return {Object} The resulting paginated object
	 * @property {Object[]} items - The chunk of items for the current page
	 * @property {number} page - The current page
	 * @property {number} maxPage - The maximum page
	 * @property {number} pageLength - The numer of items per page
	 * @property {string} pageText - The current page string (&quot;page x of y&quot;)
	 */
	static paginate(items, page = 1, pageLength = 10) {
		const maxPage = Math.ceil(items.length / pageLength);
		if(page &lt; 1) page = 1;
		if(page &gt; maxPage) page = maxPage;
		let startIndex = (page - 1) * pageLength;
		return {
			items: items.length &gt; pageLength ? items.slice(startIndex, startIndex + pageLength) : items,
			page: page,
			maxPage: maxPage,
			pageLength: pageLength,
			pageText: `page ${page} of ${maxPage}`
		};
	}

	/**
	 * Search for matches in a list of items
	 * @param {Object[]} items - An array of items to search in
	 * @param {string} searchString - The string to search for
	 * @param {Object} options - An options object
	 * @param {string} [options.property=name] - The property on items to search against
	 * @param {boolean} [options.searchInexact=true] - Whether or not to search for inexact matches
	 * @param {boolean} [options.searchExact=true] - Whether or not to search for exact matches (will narrow down inexact matches if applicable)
	 * @param {boolean} [options.useStartsWith=false] - Whether or not to search inexact by checking to see if the item starts with the search string rather than contains
	 * @return {Object[]} The matched items
	 */
	static search(items, searchString, { property = &apos;name&apos;, searchInexact = true, searchExact = true, useStartsWith = false } = {}) {
		if(!items || items.length === 0) return [];
		if(!searchString) return items;

		const lowercaseSearch = searchString.toLowerCase();
		let matchedItems;

		// Find all items that start with or include the search string
		if(searchInexact) {
			if(useStartsWith &amp;&amp; searchString.length === 1) {
				matchedItems = items.filter(element =&gt; String(property ? element[property] : element)
					.normalize(&apos;NFKD&apos;)
					.toLowerCase()
					.startsWith(lowercaseSearch)
				);
			} else {
				matchedItems = items.filter(element =&gt; String(property ? element[property] : element)
					.normalize(&apos;NFKD&apos;)
					.toLowerCase()
					.includes(lowercaseSearch)
				);
			}
		} else {
			matchedItems = items;
		}

		// See if any are an exact match
		if(searchExact &amp;&amp; matchedItems.length &gt; 1) {
			const exactItems = matchedItems.filter(element =&gt; String(property ? element[property] : element).normalize(&apos;NFKD&apos;).toLowerCase() === lowercaseSearch);
			if(exactItems.length &gt; 0) return exactItems;
		}

		return matchedItems;
	}

	/**
	 * Splits a string using specified characters into multiple strings of a maximum length
	 * @param {string} text - The string to split
	 * @param {number} [maxLength=1925] - The maximum length of each split string
	 * @param {string} [splitOn=\n] - The characters to split the string with
	 * @return {string[]} The split strings
	 */
	static split(text, maxLength = 1925, splitOn = &apos;\n&apos;) {
		const splitText = text.split(splitOn);
		if(splitText.length === 1 &amp;&amp; text.length &gt; maxLength) throw new Error(&apos;Message exceeds the max length and contains no split characters.&apos;);
		const messages = [&apos;&apos;];
		let msg = 0;
		for(let i = 0; i &lt; splitText.length; i++) {
			if(messages[msg].length + splitText[i].length + 1 &gt; maxLength) {
				messages.push(&apos;&apos;);
				msg++;
			}
			messages[msg] += (messages[msg].length &gt; 0 ? &apos;\n&apos; : &apos;&apos;) + splitText[i];
		}
		return messages;
	}

	/**
	 * Convert spaces to non-breaking spaces
	 * @param {string} text - The text to convert
	 * @return {string} The converted text
	 */
	static nbsp(text) {
		return String(text).replace(spacePattern, nbsp);
	}

	/**
	 * Useful pattern constants
	 * @type {Object}
	 */
	static get patterns() {
		return patterns;
	}

	/**
	 * Creates a regular expression to match the command prefix and name in a message
	 * @param {?Server} server - A Discord.js Server instance of the server that the message is from
	 * @param {User} user - The Discord.js User instance of the bot
	 * @return {RegExp} Regular expression that matches a command prefix and name
	 */
	static _buildCommandPattern(server, user) {
		let prefix = server ? Setting.getValue(&apos;command-prefix&apos;, config.commandPrefix, server) : config.commandPrefix;
		if(prefix === &apos;none&apos;) prefix = &apos;&apos;;
		const escapedPrefix = escapeRegex(prefix);
		const prefixPatternPiece = prefix ? `${escapedPrefix}\\s*|` : &apos;&apos;;
		const pattern = new RegExp(`^(${prefixPatternPiece}&lt;@!?${user.id}&gt;\\s+(?:${escapedPrefix})?)([^\\s]+)`, &apos;i&apos;);
		bot.logger.info(`Server command pattern built.`, { server: server ? server.name : null, serverID: server ? server.id : null, prefix: prefix, pattern: pattern.source });
		return pattern;
	}

	/**
	 * Checks for an update for the bot
	 * @return {void}
	 */
	static _checkForUpdate() {
		request(config.updatePackageURL, (error, response, body) =&gt; {
			if(error) {
				bot.logger.warn(&apos;Error while checking for update&apos;, error);
				return;
			}
			if(response.statusCode !== 200) {
				bot.logger.warn(&apos;Error while checking for update&apos;, { statusCode: response.statusCode });
				return;
			}

			const masterVersion = JSON.parse(body).version;
			if(!semver.gt(masterVersion, config.botVersion)) return;
			const message = `An update for ${config.botName} is available! Current version is ${config.botVersion}, latest available is ${masterVersion}.`;
			bot.logger.warn(message);
			const savedVersion = Setting.getValue(&apos;notified-version&apos;);
			if(savedVersion !== masterVersion &amp;&amp; bot.client &amp;&amp; config.owner) {
				bot.client.sendMessage(config.owner, message);
				Setting.save(new Setting(null, &apos;notified-version&apos;, masterVersion));
			}
		});
	}
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.8)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
