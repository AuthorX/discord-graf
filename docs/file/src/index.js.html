<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/index.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/Gawdl3y/discord-graf.git" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/util.js~Util.html">Util</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-loadYargs">loadYargs</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setDefaults">setDefaults</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setValues">setValues</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isAdmin">isAdmin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isMod">isMod</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-defaults">defaults</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-values">values</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-graf">graf</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-serverCommandPatterns">serverCommandPatterns</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-unprefixedCommandPattern">unprefixedCommandPattern</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-version">version</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">commands</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-handleMessage">handleMessage</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-makeResultObject">makeResultObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-matchDefault">matchDefault</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-parseMessage">parseMessage</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-run">run</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sendMessages">sendMessages</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sendMessagesForResult">sendMessagesForResult</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-updateMessages">updateMessages</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-updateMessagesForResult">updateMessagesForResult</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-find">find</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isUsable">isUsable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-nameGroup">nameGroup</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-register">register</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-commandResults">commandResults</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-serverCommandPatterns">serverCommandPatterns</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-unprefixedCommandPattern">unprefixedCommandPattern</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-commands">commands</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-groups">groups</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">database</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/database/mod-role.js~ModRole.html">ModRole</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/database/setting.js~Setting.html">Setting</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/database/usable-channel.js~UsableChannel.html">UsableChannel</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">errors</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/errors/command-format.js~CommandFormatError.html">CommandFormatError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/errors/friendly.js~FriendlyError.html">FriendlyError</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/index.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">&apos;use babel&apos;;
&apos;use strict&apos;;

import Discord from &apos;discord.js&apos;;
import { LocalStorage } from &apos;node-localstorage&apos;;
import winston from &apos;winston&apos;;
import * as config from &apos;./config&apos;;
import version from &apos;./version&apos;;
import * as registry from &apos;./commands/registry&apos;;
import * as dispatcher from &apos;./commands/dispatcher&apos;;
import Setting from &apos;./database/setting&apos;;
import ModRole from &apos;./database/mod-role&apos;;
import UsableChannel from &apos;./database/usable-channel&apos;;
import * as permissions from &apos;./permissions&apos;;
import FriendlyError from &apos;./errors/friendly&apos;;
import CommandFormatError from &apos;./errors/command-format&apos;;
import Util from &apos;./util&apos;;

import HelpCommand from &apos;./commands/general/help&apos;;
import AboutCommand from &apos;./commands/general/about&apos;;
import PrefixCommand from &apos;./commands/general/prefix&apos;;
import EvalCommand from &apos;./commands/general/eval&apos;;
import ListRolesCommand from &apos;./commands/general/list-roles&apos;;
import ListModRolesCommand from &apos;./commands/roles/list&apos;;
import AddModRoleCommand from &apos;./commands/roles/add&apos;;
import DeleteModRoleCommand from &apos;./commands/roles/delete&apos;;
import ClearModRolesCommand from &apos;./commands/roles/clear&apos;;
import ListAllowedChannelsCommand from &apos;./commands/channels/list&apos;;
import AllowChannelCommand from &apos;./commands/channels/allow&apos;;
import DisallowChannelCommand from &apos;./commands/channels/disallow&apos;;
import ClearAllowedChannelsCommand from &apos;./commands/channels/clear&apos;;

export const serverCommandPatterns = {};
export const unprefixedCommandPattern = /^([^\s]+)/i;

export const graf = {
	client: null,
	version: version,
	registry: registry,
	dispatcher: dispatcher,
	permissions: permissions,
	util: Util,
	errors: {
		FriendlyError: FriendlyError,
		CommandFormatError: CommandFormatError
	},

	Setting: Setting,
	ModRole: ModRole,
	UsableChannel: UsableChannel,

	createClient(configObj) {
		config.setValues(configObj);

		// Output safe config
		const debugConfig = Object.assign({}, config.values);
		if(debugConfig.email) debugConfig.email = &apos;--snip--&apos;;
		if(debugConfig.password) debugConfig.password = &apos;--snip--&apos;;
		if(debugConfig.token) debugConfig.token = &apos;--snip--&apos;;
		for(const key of Object.keys(debugConfig)) if(key.length === 1 || key.includes(&apos;-&apos;)) delete debugConfig[key];
		this.logger.debug(&apos;Configuration:&apos;, debugConfig);

		// Verify some stuff
		if(!config.values.token &amp;&amp; (!config.values.email || !config.values.password)) throw new Error(&apos;Invalid credentials; either &quot;token&quot; or both &quot;email&quot; and &quot;password&quot; must be specified on the config.&apos;);
		if(!config.values.botName) throw new Error(&apos;&quot;botName&quot; must be specified on the config.&apos;);
		if(!config.values.botVersion) throw new Error(&apos;&quot;botVersion&quot; must be specified on the config.&apos;);

		// Create client
		const clientOptions = { autoReconnect: config.values.autoReconnect, forceFetchUsers: true, disableEveryone: config.values.disableEveryone };
		const client = new Discord.Client(clientOptions);
		this.logger.info(&apos;Client created.&apos;, clientOptions);
		client.on(&apos;error&apos;, err =&gt; { this.logger.error(err); });
		client.on(&apos;warn&apos;, err =&gt; { this.logger.warn(err); });
		client.on(&apos;debug&apos;, err =&gt; { this.logger.debug(err); });
		client.on(&apos;disconnected&apos;, () =&gt; { this.logger.error(&apos;Disconnected.&apos;); });
		client.on(&apos;ready&apos;, () =&gt; {
			this.logger.info(`Bot is ready; logged in as ${client.user.username}#${client.user.discriminator} (ID: ${client.user.id})`);
			if(config.values.playingGame) client.setPlayingGame(config.values.playingGame);
		});

		// Set up command handling
		client.on(&apos;message&apos;, message =&gt; {
			if(message.author.equals(client.user)) return;
			dispatcher.handleMessage(message).catch(err =&gt; { this.logger.error(err); });
		});
		client.on(&apos;messageUpdated&apos;, (oldMessage, newMessage) =&gt; {
			if(newMessage.author.equals(client.user)) return;
			dispatcher.handleMessage(newMessage, oldMessage).catch(err =&gt; { this.logger.error(err); });
		});

		// Log in
		const loginCallback = err =&gt; { if(err) this.logger.error(&apos;Failed to login.&apos;, err); };
		if(config.values.token) {
			this.logger.info(&apos;Logging in with token...&apos;);
			client.loginWithToken(config.values.token, config.values.email, config.values.password, loginCallback);
		} else {
			this.logger.info(&apos;Logging in with email and password...&apos;);
			client.login(config.values.email, config.values.password, loginCallback);
		}

		// Check for updates now and at an interval
		if(config.values.updatePackageURL) {
			Util._checkForUpdate();
			if(config.values.updateCheck &gt; 0) setInterval(Util._checkForUpdate, config.values.updateCheck * 60 * 1000);
		}

		this.client = client;
		return client;
	},

	registerCommands(commands) {
		for(const command of commands) this.registry.register(command);
	},

	nameGroups(groups) {
		for(const group of groups) this.registry.nameGroup(...group);
	},

	registerDefaultCommands() {
		this.registerCommands([
			HelpCommand,
			AboutCommand,
			PrefixCommand,
			EvalCommand,
			ListRolesCommand,
			ListModRolesCommand,
			AddModRoleCommand,
			DeleteModRoleCommand,
			ClearModRolesCommand,
			ListAllowedChannelsCommand,
			AllowChannelCommand,
			DisallowChannelCommand,
			ClearAllowedChannelsCommand
		]);
		this.nameGroups([
			[&apos;general&apos;, &apos;General&apos;],
			[&apos;roles&apos;, &apos;Roles&apos;],
			[&apos;channels&apos;, &apos;Channels&apos;]
		]);
	},

	get config() {
		if(!this._config) {
			config.setDefaults();
			this._config = config;
		}
		return this._config;
	},

	get logger() {
		if(!this._logger) {
			this._logger = new winston.Logger({
				transports: [
					new winston.transports.Console({
						level: config.values.consoleLevel,
						colorize: true,
						timestamp: true,
						handleExceptions: true,
						humanReadableUnhandledException: true
					})
				]
			});
			if(config.values.log) {
				this._logger.add(winston.transports.File, {
					level: config.values.logLevel,
					filename: config.values.log,
					maxsize: config.values.logMaxSize,
					maxFiles: config.values.logMaxFiles,
					tailable: true,
					json: false,
					handleExceptions: true,
					humanReadableUnhandledException: true
				});
			}
		}

		return this._logger;
	},

	get storage() {
		if(!this._storage) this._storage = new LocalStorage(config.values.storage);
		return this._storage;
	}
};
export default graf;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.8)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
